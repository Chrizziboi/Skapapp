<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Database Backup & Restore</title>
    <link rel="stylesheet" href="/static/styles/admin_backup.css">
</head>
<body>
    <div class="container">
        <div class="navigation">
            <button onclick="goBack()">← Tilbake</button>
            <button onclick="logout()">Logg Ut</button>
        </div>

        <h1>Backup & Restore</h1>

        <h2>Last ned eksisterende backup</h2>
        <form action="/admin/backup" method="get">
            <button type="submit">Last ned backup_database.txt</button>
        </form>

        <h2>Gjenopprett database fra backup</h2>
        <form action="/admin/restore" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept=".txt,.json" required>
            <button type="submit">Last opp og gjenopprett</button>
        </form>
    </div>

    <script>
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000; // 3 sekunder

        const connectWebSocket = () => {
            if (socket) socket.close();

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/updates`;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("WebSocket connection established.");
                reconnectAttempts = 0;
            };

            socket.onmessage = (event) => {
                const message = event.data;
                console.log("WebSocket message received:", message);
                if (message === "update") {
                    alert("Databasen ble oppdatert – last inn siden på nytt for å se endringer.");
                }
            };

            socket.onclose = (event) => {
                console.warn("WebSocket connection closed", event);
                if (!event.wasClean && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, reconnectDelay);
                }
            };

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        };

        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('token');

            if (!token) {
                window.location.href = "/";
                return;
            }

            fetch("/api/admin/data", {
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(res => {
                if (!res.ok) throw new Error("Unauthorized");
                return res.json();
            })
            .then(data => {
                console.log("Bruker er autorisert.");
                connectWebSocket(); // Start WebSocket etter godkjent token
            })
            .catch(err => {
                console.error("Uautorisert tilgang:", err);
                localStorage.removeItem('token');
                window.location.href = "/";
            });
        });

        function goBack() {
            window.history.back();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = "/";
        }
    </script>
</body>
</html>
