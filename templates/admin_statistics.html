<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Statistikk</title>
    <link rel="stylesheet" href="/static/styles/admin_statistics.css">
</head>
<body>
    <div class="container">
        <h1>Statistikkoversikt</h1>

        <div class="summary">
            <p><strong>Totalt antall skap:</strong> <span id="total-lockers">...</span></p>
            <p><strong>Ledige skap:</strong> <span id="available-lockers">...</span></p>
            <p><strong>Opptatte skap:</strong> <span id="occupied-lockers">...</span></p>
            <p><strong>Totalt antall brukere:</strong> <span id="total-users">...</span></p>
        </div>

        <h2>Skap per garderoberom</h2>
        <table>
            <thead>
                <tr>
                    <th>Romnavn</th>
                    <th>Totalt</th>
                    <th>Ledige</th>
                    <th>Opptatte</th>
                </tr>
            </thead>
            <tbody id="lockers-by-room">
                <!-- Fylles av JS -->
            </tbody>
        </table>

        <h2>Rom med flest opptatte skap</h2>
        <ul id="most-used-rooms"></ul>

        <h2>Mest aktive brukere</h2>
        <ul id="most-active-users"></ul>

        <div class="navigation-buttons">
            <button onclick="location.href='/admin_page'">‚Üê Tilbake</button>
            <button onclick="location.href='/'">üè† Hjem</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const safeFetch = (url, callback, fallbackId) => {
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (Array.isArray(data)) {
                            callback(data);
                        } else {
                            document.getElementById(fallbackId).innerHTML = "<li>Kunne ikke hente data.</li>";
                            console.error("Ugyldig respons:", data);
                        }
                    })
                    .catch(err => {
                        document.getElementById(fallbackId).innerHTML = "<li>Feil under lasting av data.</li>";
                        console.error("Fetch-feil:", err);
                    });
            };

            fetch("/statistic/total_lockers")
                .then(res => res.json())
                .then(data => document.getElementById("total-lockers").innerText = data.total_lockers);

            fetch("/statistic/available_lockers")
                .then(res => res.json())
                .then(data => document.getElementById("available-lockers").innerText = data.available_lockers);

            fetch("/statistic/occupied_lockers")
                .then(res => res.json())
                .then(data => document.getElementById("occupied-lockers").innerText = data.occupied_lockers);

            fetch("/statistic/total_users")
                .then(res => res.json())
                .then(data => document.getElementById("total-users").innerText = data.total_users);

            safeFetch("/statistic/lockers_by_room", data => {
                const tbody = document.getElementById("lockers-by-room");
                tbody.innerHTML = "";
                data.forEach(row => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.room_name}</td>
                        <td>${row.locker_count}</td>
                        <td>${row.available}</td>
                        <td>${row.occupied}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }, "lockers-by-room");

            safeFetch("/statistic/most_used_rooms", data => {
                const list = document.getElementById("most-used-rooms");
                list.innerHTML = "";
                data.forEach(room => {
                    list.innerHTML += `<li>${room.room_name} ‚Äì ${room.occupied_count} opptatte skap</li>`;
                });
            }, "most-used-rooms");

            safeFetch("/statistic/most_active_users", data => {
                const list = document.getElementById("most-active-users");
                list.innerHTML = "";
                data.forEach(user => {
                    list.innerHTML += `<li>${user.username} ‚Äì ${user.reservations} reserveringer</li>`;
                });
            }, "most-active-users");
        });
    </script>
</body>
</html>