<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Statistikk</title>
    <link rel="stylesheet" href="/static/styles/admin_statistics.css">
</head>
<body>
    <nav class="admin-navbar">
        <ul class="nav-menu">
            <li><button onclick="location.href='/admin_page'">Oversikt</button></li>
            <li><button onclick="location.href='/admin_wardrobe_management'">Garderobe admin</button></li>
            <li><button onclick="location.href='/admin_statistics'">Statistikk</button></li>
            <li><button onclick="location.href='/logout'">Logg ut</button></li>
        </ul>
    </nav>
    <main>
        <div class="container">
            <h1>Statistikkoversikt</h1>

            <div class="summary">
                <p><strong>Totalt antall skap:</strong> <span id="total-lockers">...</span></p>
                <p><strong>Ledige skap:</strong> <span id="available-lockers">...</span></p>
                <p><strong>Totalt antall brukere:</strong> <span id="total-users">...</span></p>
            </div>

            <div class="stat-card">
                <h2>ğŸ“Š Skap per garderoberom</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Romnavn</th>
                            <th>Totalt</th>
                            <th>Ledige</th>
                            <th>Opptatte</th>
                        </tr>
                    </thead>
                    <tbody id="lockers-by-room">
                        <!-- Fylles av JS -->
                    </tbody>
                </table>
            </div>

            <div class="stat-card">
                <h2>ğŸ† Rom med flest bruk</h2>
                <ul id="most-used-rooms"></ul>
            </div>

            <div class="stat-card">
                <h2>ğŸ”¥ Mest aktive brukere</h2>
                <ul id="most-active-users"></ul>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const fetchText = (url, targetId, key) => {
                fetch(url)
                    .then(res => res.json())
                    .then(data => document.getElementById(targetId).innerText = data[key])
                    .catch(err => {
                        document.getElementById(targetId).innerText = "Feil";
                        console.error(err);
                    });
            };

            const fetchList = (url, targetId, formatFn) => {
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const list = document.getElementById(targetId);
                        list.innerHTML = "";
                        data.forEach(item => {
                            const li = document.createElement("li");
                            li.innerText = formatFn(item);
                            list.appendChild(li);
                        });
                    })
                    .catch(err => {
                        document.getElementById(targetId).innerHTML = "<li>Feil ved henting.</li>";
                        console.error(err);
                    });
            };

            // ğŸ”¢ Tallverdier
            fetchText("/statistic/total_lockers", "total-lockers", "total_lockers");
            fetchText("/statistic/available_lockers", "available-lockers", "available_lockers");
            fetchText("/statistic/total_users", "total-users", "total_users");

            // ğŸ“Š Skap per rom
            fetch("/statistic/lockers_by_room")
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("lockers-by-room");
                    tbody.innerHTML = "";
                    data.forEach(row => {
                        const tr = document.createElement("tr");
                        tr.innerHTML =
                                "<td>" + row.room_name + "</td>" +
                                "<td>" + row.locker_count + "</td>" +
                                "<td>" + (row.available !== undefined ? row.available : "-") + "</td>" +
                                "<td>" + (row.occupied !== undefined ? row.occupied : "-") + "</td>";

                        tbody.appendChild(tr);
                    });
                });

            // ğŸ† Mest brukte rom
            fetchList("/statistic/most_used_rooms", "most-used-rooms", room =>
                `${room.room_name} â€“ ${room.occupied_count} bruk`
            );

            // ğŸ”¥ Mest aktive brukere
            fetchList("/statistic/most_active_users", "most-active-users", user =>
                `${user.username} â€“ ${user.locker_count} handlinger`
            );
        });
    </script>
</body>
</html>
