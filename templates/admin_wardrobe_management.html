<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Garderobe Administrasjon</title>
    <link rel="stylesheet" href="/static/styles/admin_rooms.css">
</head>
<body>

    <!-- Admin Navbar -->
    <div class="admin-navbar-wrapper">
        <div class="admin-navbar">
            <ul class="nav-menu">
                <li><button onclick="navigateTo('overview')">Oversikt</button></li>
                <li><button onclick="navigateTo('wardrobe_admin')">Garderobe admin</button></li>
                <li><button onclick="navigateTo('statistics')">Statistikk</button></li>
                <li><button onclick="navigateTo('backup')">Gjenopprettelse</button></li>
                <li><button onclick="logout()">Logg ut</button></li>
            </ul>

        </div>
    </div>

    <main>
        <div class="wardrobe-admin-layout">
            <section class="card card-left glassmorphic">
                <h2>Opprett garderoberom</h2>
                <div class="input-row">
                    <input type="text" id="roomName" placeholder="Skriv inn romnavn">
                    <button class="create-room-btn" onclick="createRoom()">Opprett</button>
                </div>
            </section>

            <section class="card card-bottom glassmorphic">
                <h2>Legg til garderobeskap</h2>
                <div class="dropdown-row">
                    <label for="room-dropdown">Velg rom:</label>
                    <select id="room-dropdown"></select>
                </div>
                <div class="dropdown-row">
                    <label for="locker-quantity">Antall skap:</label>
                    <input type="number" id="locker-quantity" min="1" placeholder="Antall">
                    <button class="add-lockers-btn" id="add-lockers-btn">Legg til</button>
                </div>
            </section>

            <section class="card card-right glassmorphic">
                <h2>Garderoberom</h2>
                <div class="scrollable-list">
                    <ul id="room-list" class="room-list"></ul>
                </div>
            </section>

            <div id="room-info-modal" class="modal hidden">
                <section id="room-info-box" class="card glassmorphic">
                    <button id="close-info-box">×</button>
                    <h2 id="info-room-name"></h2>
                    <p id="info-room-id"></p>
                    <p id="info-locker-details"></p>

                    <div class="input-row">
                        <input type="text" id="edit-room-name" placeholder="Nytt romnavn">
                        <button onclick="updateRoomName()">Oppdater navn</button>
                        <button class="button-danger" onclick="deleteRoom(selectedRoomId)">Slett rom</button>
                    </div>

                    <h3>Skap i rommet</h3>
                    <table id="locker-list" style="width: 100%; margin-top: 16px; border-spacing: 0 8px;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Handling</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>
            </div>
        </div>
    </main>

    <!-- Overlay for info box -->
    <div id="info-overlay" class="overlay hidden"></div>

    <script>
        let selectedRoomId = null;

        document.addEventListener("DOMContentLoaded", function () {
            fetchRooms();
            fetchLockersInRoom();

            document.getElementById("add-lockers-btn").addEventListener("click", createMultipleLockers);

            // Oppdater selectedRoomId når brukeren velger et rom fra dropdown
            document.getElementById("room-dropdown").addEventListener("change", function () {
                selectedRoomId = this.value;
            });

            // Skjul info-boksen som standard
            document.getElementById("room-info-modal").classList.add("hidden");

            // Lukk info-boksen når man klikker på ×
            document.getElementById("close-info-box").addEventListener("click", () => {
                document.getElementById("room-info-modal").classList.add("hidden");
            });

            // ESC for å lukke info-boks
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape") {
                    document.getElementById("room-info-modal").classList.add("hidden");
                }
            });
        });

        // Henter alle garderoberom
        function fetchRooms() {
            fetch("/locker_rooms/")
                .then(response => response.json())
                .then(data => {
                    const roomList = document.getElementById("room-list");
                    roomList.innerHTML = "";

                    // Add: Prepare and clear the room dropdown
                    const roomDropdown = document.getElementById("room-dropdown");
                    if (roomDropdown) {
                        roomDropdown.innerHTML = '<option value="">Velg rom</option>';
                    }

                    data.forEach(room => {
                        let listItem = document.createElement("li");
                        listItem.textContent = `${room.name} (ID: ${room.room_id})`;
                        listItem.classList.add("room-item");
                        listItem.onclick = () => selectRoom(room.room_id, room.name);

                        // Info button only (refactored)
                        let infoButton = document.createElement("button");
                        infoButton.textContent = "Innstillinger";
                        infoButton.classList.add("info-button");
                        infoButton.onclick = (event) => {
                            event.stopPropagation();
                            showRoomInfo(room);
                        };
                        listItem.appendChild(infoButton);
                        roomList.appendChild(listItem);

                        // Add: Also add to dropdown
                        if (roomDropdown) {
                            const option = document.createElement("option");
                            option.value = room.room_id;
                            option.textContent = `${room.name} (ID: ${room.room_id})`;
                            roomDropdown.appendChild(option);
                        }
                    });
                })
                .catch(error => console.error("Error fetching rooms:", error));
        }

        // Velger et rom og viser skapene i det
        function selectRoom(roomId, roomName) {
            selectedRoomId = roomId;  // Sørg for at denne blir oppdatert
            document.getElementById("selected-room-name").textContent = `Valgt garderoberom: ${roomName}`;
            document.getElementById("create-locker-btn").disabled = false;
            document.getElementById("create-multiple-lockers-btn").disabled = false;  // Aktiver knappen
            document.getElementById("delete-all-lockers-btn").disabled = false;
            fetchLockersInRoom(roomId);
        }


        // Oppretter et nytt garderoberom
        function createRoom() {
            const roomName = document.getElementById("roomName").value.trim();
            if (!roomName) {
                alert("Please enter a room name.");
                return;
            }

            fetch(`http://localhost:8080/locker_rooms/${encodeURIComponent(roomName)}`, { method: "POST" })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.detail); });
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById("room-created-modal").classList.remove("hidden");
                    fetchRooms();
                })
                .catch(error => {
                    console.error("Error creating room:", error);
                    alert("Failed to create room: " + error.message);
                });

            document.getElementById("roomName").value = "";
        }

        function createMultipleLockers() {
            if (!selectedRoomId) {
                alert("Vennligst velg et rom før du oppretter flere skap.");
                return;
            }

            const quantity = document.getElementById("locker-quantity").value;

            if (quantity < 1) {
                alert("Oppgi et gyldig antall skap.");
                return;
            }

            fetch(`http://localhost:8080/lockers/multiple_lockers?locker_room_id=${selectedRoomId}&quantity=${quantity}`, {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("lockers-created-modal").classList.remove("hidden");
                fetchLockersInRoom(selectedRoomId);
            })
            .catch(error => {
                console.error("Feil ved oppretting av flere skap:", error);
            });
        }



        // Viser informasjon om et garderoberom
        function showRoomInfo(room) {
            // Set selectedRoomId when showing info
            selectedRoomId = room.room_id;
            const infoModal = document.getElementById("room-info-modal");
            const infoBox = document.getElementById("room-info-box");
            document.getElementById("info-room-name").textContent = `Romnavn: ${room.name}`;
            document.getElementById("info-room-id").textContent = `Rom-ID: ${room.room_id}`;

            fetch("/lockers/")
                .then(response => response.json())
                .then(lockers => {
                    const roomLockers = lockers.filter(l => l.locker_room_id == room.room_id);
                    const total = roomLockers.length;
                    const available = roomLockers.filter(l => l.status === 'Ledig').length;
                    const used = total - available;
                    document.getElementById("info-locker-details").textContent =
                        `Totalt skap: ${total} – Ledige: ${available}, Brukt: ${used}`;

                    // Populate input with current name
                    if (document.getElementById("edit-room-name")) {
                        document.getElementById("edit-room-name").value = room.name;
                    }

                    // Populate locker list
                    const lockerList = document.querySelector("#locker-list tbody");
                    if (lockerList) {
                        lockerList.innerHTML = "";
                        roomLockers.forEach(locker => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${locker.combi_id}</td>
                                <td>${locker.status}</td>
                                <td><button class="button-danger" onclick="removeLocker(${locker.locker_id})">Slett</button></td>
                            `;
                            lockerList.appendChild(row);
                        });
                    }
                });
            infoModal.classList.remove("hidden");
        }

        document.addEventListener("DOMContentLoaded", function () {
            fetchRooms();
            fetchLockersInRoom();
            document.getElementById("add-lockers-btn").addEventListener("click", createMultipleLockers);
            // Oppdater selectedRoomId når brukeren velger et rom fra dropdown
            document.getElementById("room-dropdown").addEventListener("change", function () {
                selectedRoomId = this.value;
            });
            // Koble modal-close etter at DOM er ferdig lastet
            document.getElementById("modal-close").onclick = function () {
                document.getElementById("room-modal").classList.add("hidden");
            };
        });

        // Sletter et garderoberom med modal-bekreftelse
        function deleteRoom(roomId) {
            const modal = document.getElementById("confirm-delete-modal");
            const confirmBtn = document.getElementById("confirm-delete");
            const cancelBtn = document.getElementById("cancel-delete");

            modal.classList.remove("hidden");

            const onConfirm = () => {
                fetch(`/locker_rooms/${roomId}`, { method: "DELETE" })
                    .then(response => response.json())
                    .then(() => {
                        showSuccessModal("Rommet har blitt slettet.");
                        fetchRooms();
                        document.getElementById("room-info-modal").classList.add("hidden");
                        if (roomId === selectedRoomId) {
                            selectedRoomId = null;
                            document.getElementById("selected-room-name").textContent = "Ingen rom valgt!";
                            document.getElementById("create-locker-btn").disabled = true;
                            document.getElementById("locker-table").innerHTML = "";
                            document.getElementById("delete-all-lockers-btn").disabled = true;
                        }
                    })
                    .catch(error => console.error("Error deleting room:", error))
                    .finally(() => {
                        modal.classList.add("hidden");
                        confirmBtn.removeEventListener("click", onConfirm);
                        cancelBtn.removeEventListener("click", onCancel);
                    });
            };

            const onCancel = () => {
                modal.classList.add("hidden");
                confirmBtn.removeEventListener("click", onConfirm);
                cancelBtn.removeEventListener("click", onCancel);
            };

            confirmBtn.addEventListener("click", onConfirm);
            cancelBtn.addEventListener("click", onCancel);
        }

        // Henter skap i et spesifikt rom
        function fetchLockersInRoom(roomId) {
            fetch("/lockers/")
                .then(response => response.json())
                .then(data => {
                    const lockerTable = document.getElementById("locker-table");
                    lockerTable.innerHTML = "";

                    const roomLockers = data.filter(locker => locker.locker_room_id == roomId);

                    roomLockers.forEach(locker => {
                        let row = `<tr>
                            <td>${locker.combi_id}</td>
                            <td>${locker.status}</td>
                            <td>
                                  <input
                                    type="text"
                                    id="note-input-${locker.locker_id}"
                                    value="${locker.note !== "N/A" ? locker.note : ""}"
                                    placeholder="Skriv notat..."
                                  />
                                  <button onclick="updateNote(${locker.locker_id})">Lagre</button>
                            </td>
                            <td>
                                <button onclick="unlockLocker(${locker.locker_id})">Lås opp</button>
                                <button onclick="removeLocker(${locker.locker_id})">Slett</button>
                            </td>
                        </tr>`;
                        lockerTable.innerHTML += row;
                    });
                })
                .catch(error => console.error("Error fetching lockers:", error));
        }

        // Oppretter et nytt skap
        function createLocker() {
            if (!selectedRoomId) {
                alert("Vennligst velg et rom først.");
                return;
            }

            fetch(`http://localhost:8080/lockers/?locker_room_id=${selectedRoomId}`, {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || "Skap opprettet!");
                fetchLockersInRoom(selectedRoomId);
            })
            .catch(error => {
                console.error("Feil ved oppretting av skap:", error);
            });
        }

        // Låser opp et skap
        function unlockLocker(lockerId) {
            fetch(`/lockers/${lockerId}/unlock`, { method: "PUT" })
                .then(response => response.json())
                .then(data => {
                    alert(`Locker ${lockerId} unlocked.`);
                    fetchLockersInRoom(selectedRoomId);
                })
                .catch(error => console.error("Error unlocking locker:", error));
        }

        // Sletter et skap
        function removeLocker(lockerId) {
            fetch(`http://localhost:8080/lockers/${lockerId}`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                // Refresh the info box after deletion
                if (selectedRoomId) showRoomInfo({ room_id: selectedRoomId, name: document.getElementById("info-room-name").textContent.replace("Romnavn: ", "") });
            })
            .catch(error => console.error("Error deleting locker:", error));
        }

        function updateNote(lockerId) {
            const note = document.getElementById(`note-input-${lockerId}`).value;
            fetch(`/lockers/${lockerId}/note?note=${encodeURIComponent(note)}`, {
                method: "PUT"
            })
            .then(response => {
                if (!response.ok) throw new Error("Noe gikk galt med oppdatering");
                return response.json();
            })
            .then(data => {
                alert("Notat lagret!");
                fetchLockersInRoom(selectedRoomId);
            })
            .catch(error => {
                console.error("Feil ved oppdatering av notat:", error);
                alert("Kunne ikke oppdatere notat.");
            });
        }
        function deleteAllLockers() {
            if (!selectedRoomId) {
                alert("Vennligst velg et rom først.");
                return;
            }

            const confirmation = confirm("Er du sikker på at du vil slette alle skap i dette rommet?");
            if (!confirmation) return;

            fetch(`http://localhost:8080/locker_rooms/${selectedRoomId}/lockers`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || "Alle skap slettet.");
                fetchLockersInRoom(selectedRoomId);
            })
            .catch(error => {
                console.error("Feil ved sletting av alle skap:", error);
                alert("Noe gikk galt under slettingen.");
            });
        }

        // Oppdaterer garderoberomnavn med PUT-request
        function updateRoomName() {
            const newName = document.getElementById("edit-room-name").value.trim();
            if (!selectedRoomId) {
                alert("Ingen rom valgt.");
                return;
            }
            if (!newName) {
                alert("Vennligst skriv inn nytt navn.");
                return;
            }

            fetch(`/locker_rooms/${selectedRoomId}?new_name=${encodeURIComponent(newName)}`, {
                method: "PUT"
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.detail); });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message || "Navn oppdatert!");
                fetchRooms();
                document.getElementById("edit-room-name").value = "";
                showRoomInfo({ room_id: selectedRoomId, name: newName });
            })
            .catch(error => {
                console.error("Feil ved oppdatering av romnavn:", error);
                alert("Kunne ikke oppdatere romnavnet.");
            });
        }

        function navigateTo(page) {
            if (page === 'overview') {
                window.location.href = "/admin_page";
            } else if (page === 'wardrobe_admin') {
                window.location.href = "/admin_wardrobe";
            } else if (page === 'statistics') {
                window.location.href = "/admin_statistics";
            } else if (page === 'backup') {
                window.location.href = "/admin_backup";
            }
        }


        function logout() {

            window.location.href = "/";
        }
    // Success modal functions
    function showSuccessModal(message) {
        const modal = document.getElementById("success-modal");
        const msg = document.getElementById("success-message");
        msg.textContent = message;
        modal.classList.remove("hidden");
    }

    function closeSuccessModal() {
        document.getElementById("success-modal").classList.add("hidden");
    }
    </script>



    <!-- Bekreft sletting modal -->
    <div id="confirm-delete-modal" class="modal hidden">
      <div class="modal-content">
        <p>Er du sikker på at du vil slette dette rommet?</p>
        <div class="modal-buttons">
          <button id="cancel-delete" class="cancel-button">Avbryt</button>
          <button id="confirm-delete" class="delete-button">Slett</button>
        </div>
      </div>
    </div>

    <!-- Success modal -->
    <div id="success-modal" class="modal hidden">
      <div class="modal-content">
        <p id="success-message">Handling utført!</p>
        <div class="modal-buttons">
          <button onclick="closeSuccessModal()">OK</button>
        </div>
      </div>
    </div>

    <!-- Room created modal -->
    <div id="room-created-modal" class="modal hidden">
      <div class="modal-content">
        <p>Rommet har blitt opprettet!</p>
        <div class="modal-buttons">
          <button onclick="document.getElementById('room-created-modal').classList.add('hidden')">OK</button>
        </div>
      </div>
    </div>

    <!-- Lockers created modal -->
    <div id="lockers-created-modal" class="modal hidden">
      <div class="modal-content">
        <p>Skap er lagt til rommet!</p>
        <div class="modal-buttons">
          <button onclick="document.getElementById('lockers-created-modal').classList.add('hidden')">OK</button>
        </div>
      </div>
    </div>
</body>
</html>
