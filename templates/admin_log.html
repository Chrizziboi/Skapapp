<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkapApp - Logg</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles/admin_page.css">
    <!-- Bruk evt. /static/styles/theme.css om dere har felles tema -->
    <style>
        .logg-container {
            max-width: 1100px;
            margin: 30px auto 0 auto;
            background: #fff;
            padding: 2rem;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .logg-filter-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        .logg-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .logg-table th, .logg-table td {
            border-bottom: 1px solid #e0e0e0;
            padding: 0.7em 0.4em;
            text-align: left;
        }
        .logg-table th {
            background: #f6f7fa;
            font-weight: 600;
            color: #373B44;
        }
        .logg-table tr:last-child td {
            border-bottom: none;
        }
        .datepicker {
            border-radius: 8px;
            padding: 0.3em 0.7em;
            border: 1px solid #aaa;
            font-size: 1em;
            margin-right: 0.5em;
        }
        @media (max-width: 700px) {
            .logg-container { padding: 1rem; }
            .logg-filter-row { flex-direction: column; gap: 0.5rem; }
            .logg-table th, .logg-table td { font-size: 0.92em; }
        }
    </style>
</head>
<body>

    <!-- NAV-BAR: Kopiert fra admin_page.html, med en ekstra Logg-knapp -->
    <div class="admin-navbar-wrapper">
        <nav class="admin-navbar">
            <ul class="nav-menu">
                <li><button onclick="navigateTo('overview')">Oversikt</button></li>
                <li><button onclick="navigateTo('wardrobe_admin')">Garderobe admin</button></li>
                <li><button onclick="navigateTo('statistics')">Statistikk</button></li>
                <li><button onclick="navigateTo('backup')">Gjenopprettelse</button></li>
                <li><button onclick="navigateTo('log')">Logg</button></li>
                <li><button onclick="logout()">Logg ut</button></li>
            </ul>
        </nav>
    </div>

    <div class="logg-container">
        <h1>Logg - SkapApp</h1>
        <p>Her kan du se all skap-logg for de siste 5 책rene. Velg tidsrom for 책 filtrere loggen.</p>

        <div class="logg-filter-row">
            <label>Fra: <input type="date" id="from-date" class="datepicker"></label>
            <label>Til: <input type="date" id="to-date" class="datepicker"></label>
            <button onclick="fetchLogg()" style="padding:0.4em 1.2em; border-radius:8px; background:#4f98ca; color:white; border:none; font-weight:600; cursor:pointer;">Vis logg</button>
        </div>

        <div id="logg-table-wrapper">
            <table class="logg-table" id="logg-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Skap ID</th>
                        <th>Bruker ID</th>
                        <th>Handling</th>
                        <th>Tidspunkt</th>
                    </tr>
                </thead>
                <tbody id="logg-table-body">
                    <!-- Fylles med JS -->
                </tbody>
            </table>
        </div>
        <div id="logg-empty-message" style="display:none; margin-top:1em; color:#888;">Ingen logg funnet for valgt periode.</div>
    </div>

    <script>
        function navigateTo(page) {
            // Denne funksjonen m책 matche routing i din FastAPI/web-app
            const mapping = {
                overview: "/admin_page",
                wardrobe_admin: "/admin_wardrobe",
                statistics: "/admin_statistics",
                backup: "/admin_backup",
                log: "/admin_log"
            };
            window.location.href = mapping[page] || "/";
        }
        function logout() {
            window.location.href = "/logout";
        }

        // === Hent logg fra backend ===
        async function fetchLogg() {
            const from = document.getElementById("from-date").value;
            const to = document.getElementById("to-date").value;

            let url = "/locker_logs";
            const params = [];
            if (from) params.push(`from_date=${from}`);
            if (to) params.push(`to_date=${to}`);
            if (params.length) url += "?" + params.join("&");

            const tableBody = document.getElementById("logg-table-body");
            tableBody.innerHTML = "";
            document.getElementById("logg-empty-message").style.display = "none";

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Klarte ikke hente logg fra serveren.");
                const logs = await response.json();

                if (!logs.length) {
                    document.getElementById("logg-empty-message").style.display = "block";
                    return;
                }
                for (const entry of logs) {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${entry.id}</td>
                        <td>${entry.locker_id ?? "-"}</td>
                        <td>${entry.user_id ?? "-"}</td>
                        <td>${entry.action ?? "-"}</td>
                        <td>${formatTimestamp(entry.timestamp)}</td>
                    `;
                    tableBody.appendChild(row);
                }
            } catch (err) {
                alert("Feil ved henting av logg: " + err.message);
            }
        }

        function formatTimestamp(ts) {
            // Forventet ISO-format: '2024-05-25T09:01:11.123Z' eller liknende
            if (!ts) return "-";
            try {
                const d = new Date(ts);
                return d.toLocaleString("no-NO");
            } catch {
                return ts;
            }
        }

        // Sett default fra og til = i dag - 1 m책ned til i dag
        window.onload = () => {
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(today.getMonth() - 1);

            document.getElementById("from-date").value = lastMonth.toISOString().split("T")[0];
            document.getElementById("to-date").value = today.toISOString().split("T")[0];

            fetchLogg();
        };
    </script>
</body>
</html>
