<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkapApp - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles/admin_page.css">
</head>
<body>

    <div class="admin-navbar-wrapper">
        <nav class="admin-navbar">
            <ul class="nav-menu">
                <li><button onclick="navigateTo('overview')">Oversikt</button></li>
                <li><button onclick="navigateTo('wardrobe_admin')">Garderobe admin</button></li>
                <li><button onclick="navigateTo('statistics')">Statistikk</button></li>
                <li><button onclick="navigateTo('backup')">Gjenopprettelse</button></li>
                <li><button onclick="navigateTo('log')">Logg</button></li>
                <li><button onclick="logout()">Logg ut</button></li>
            </ul>
        </nav>
    </div>

    <div class="split-layout">
        <div class="admin-content-column">
            <div class="info-section">
                <h1>Velkommen til SkapApp Admin</h1>
                <p>Her kan du administrere garderober, opprette og slette skap, og se statistikk over bruken.</p>
            </div>
            <div class="overview-box full-width">
                <h2>Ledige Skap i Alle Rom</h2>
                <div id="admin-room-list" class="room-grid horizontal-layout"></div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = "/";
            return;
        }

        const payload = JSON.parse(atob(token.split('.')[1]));

        if (payload.role !== "admin") {
            localStorage.removeItem('token');
            window.location.href = "/";
            return;
        }

        fetch("/api/admin/data", {
            headers: {"Authorization": `Bearer ${token}`}
        })
                .then(res => {
                    if (!res.ok) throw new Error("Unauthorized");
                    return res.json();
                })
                .then(data => {
                    console.log("Data:", data);
                    // Her viser du admin-data til siden
                })
                .catch(err => {
                    localStorage.removeItem('token');
                    window.location.href = "/";
                });
    });


    function logout() {
        localStorage.removeItem('token');
        window.location.href = "/";
    }

    function navigateTo(page) {
        if (page === 'overview') {
            window.location.href = "/admin_page";
        } else if (page === 'wardrobe_admin') {
            window.location.href = "/admin_wardrobe";
        } else if (page === 'statistics') {
            window.location.href = "/admin_statistics";
        } else if (page === 'backup') {
            window.location.href = "/admin_backup";
        } else if (page === 'log') {
            window.location.href = "/admin_log";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const roomList = document.getElementById("admin-room-list");

        fetch("http://localhost:8080/locker_rooms/")
            .then(response => response.json())
            .then(async rooms => {
                roomList.innerHTML = '';

                const roomData = await Promise.all(rooms.map(async room => {
                    try {
                        const res = await fetch(`http://localhost:8080/locker_rooms/${room.room_id}/available_lockers`);
                        const data = await res.json();
                        return {
                            name: room.name,
                            available: data.available_lockers,
                            total: room.number_of_lockers
                        };
                    } catch (err) {
                        console.error("Feil ved henting:", err);
                        return null;
                    }
                }));

                roomData
                    .filter(room => room !== null)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach((room, i) => {
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('room-wrapper');

                        const card = document.createElement('div');
                        const colors = ['color-a', 'color-b', 'color-c', 'color-d'];
                        const colorClass = colors[i % colors.length];

                        // Calculate percentage width safely
                        let percentWidth = 0;
                        if (room.total && room.total > 0 && room.available !== undefined) {
                            percentWidth = Math.min(Math.round((room.available / room.total) * 100), 100);
                        }

                        card.classList.add('room-card', colorClass);
                        card.innerHTML = `
                            ${room.name}<br>
                            <span>${room.available} ledige skap</span>
                            <div class="room-progress">
                                <div class="room-progress-fill" style="width: ${percentWidth}%"></div>
                            </div>
                        `;

                        wrapper.appendChild(card);
                        roomList.appendChild(wrapper);
                    });

            })
            .catch(error => console.error("Feil ved henting av rom:", error));
    });
</script>
</body>
</html>
